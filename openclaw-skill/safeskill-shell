#!/usr/bin/env bash
# SafeSkill Shell — Drop-in bash replacement for OpenClaw
#
# This script replaces the SHELL that OpenClaw uses to execute commands.
# OpenClaw's exec tool runs: $SHELL -c "command"
# By setting SHELL to this script, EVERY command is intercepted.
#
# This is NOT a suggestion to the LLM. This is a real shell replacement
# that the LLM cannot bypass. If SafeSkillAgent blocks a command, the
# shell itself refuses to run it.
#
# Install: Set SHELL=/usr/local/bin/safeskill-shell in OpenClaw's environment

SOCKET_PATH="${SAFESKILL_SOCKET:-/tmp/safeskill.sock}"
REAL_SHELL="${SAFESKILL_REAL_SHELL:-/bin/bash}"

# Pass through non-command invocations directly to real shell
# (interactive shells, sourcing scripts, login shells, etc.)
if [[ $# -eq 0 ]]; then
    exec "$REAL_SHELL"
fi

# Handle all flags that aren't -c (pass through to real shell)
if [[ "$1" != "-c" ]]; then
    exec "$REAL_SHELL" "$@"
fi

# From here: we have -c "command" — this is what OpenClaw exec uses
COMMAND="${2:-}"

if [[ -z "$COMMAND" ]]; then
    exec "$REAL_SHELL" -c ""
fi

# Fast-path: pure builtins and harmless commands skip evaluation
TRIMMED="${COMMAND#"${COMMAND%%[![:space:]]*}"}"
FIRST_TOKEN="${TRIMMED%% *}"
case "$FIRST_TOKEN" in
    echo|printf|true|false|test|\[|pwd|cd|pushd|popd|export|alias|\
    type|help|set|shopt|declare|local|readonly|source|\.|builtin|\
    command|hash|let|read|trap|ulimit|umask|wait|compgen|complete|\
    dirs|disown|fg|bg|getopts|jobs|suspend|times)
        exec "$REAL_SHELL" -c "$COMMAND"
        ;;
esac

# Check if SafeSkillAgent is running
if [[ ! -S "$SOCKET_PATH" ]]; then
    echo "[SafeSkill] BLOCKED — Security agent not running (socket: $SOCKET_PATH)" >&2
    echo "[SafeSkill] Start it: safeskill start" >&2
    exit 126
fi

# JSON-encode the command
ESCAPED=$(printf '%s' "$COMMAND" | python3 -c '
import sys,json
print(json.dumps(sys.stdin.buffer.read().decode("utf-8","replace")))
' 2>/dev/null)

if [[ -z "$ESCAPED" ]]; then
    echo "[SafeSkill] BLOCKED — Could not encode command for evaluation" >&2
    exit 126
fi

# Ask SafeSkillAgent
RESULT=$(curl -sf --max-time 3 --unix-socket "$SOCKET_PATH" \
    http://localhost/evaluate \
    -H "Content-Type: application/json" \
    -d "{\"command\":${ESCAPED},\"source\":\"openclaw-shell\"}" 2>/dev/null)

if [[ $? -ne 0 ]] || [[ -z "$RESULT" ]]; then
    echo "[SafeSkill] BLOCKED — Agent unreachable" >&2
    exit 126
fi

# Parse verdict
VERDICT=$(printf '%s' "$RESULT" | python3 -c '
import sys,json
d=json.loads(sys.stdin.read())
blocked="1" if d.get("blocked",True) else "0"
v=d.get("verdict","unknown")
m=d.get("message","")
s=d.get("severity","")
print(f"{blocked}|{v}|{s}|{m}")
' 2>/dev/null)

IFS='|' read -r BLOCKED V SEV MSG <<< "$VERDICT"

if [[ "$BLOCKED" == "1" ]]; then
    echo "[SafeSkill] BLOCKED" >&2
    [[ -n "$SEV" ]] && echo "[SafeSkill] Severity: $SEV" >&2
    [[ -n "$MSG" ]] && echo "[SafeSkill] Reason: $MSG" >&2
    exit 126
fi

if [[ "$V" == "warned" ]]; then
    echo "[SafeSkill] WARNING: $MSG" >&2
fi

# Approved — run via real shell
exec "$REAL_SHELL" -c "$COMMAND"
